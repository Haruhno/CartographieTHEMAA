<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nouvel Organisme - THEMAA</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<style>
    .form-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
    }

    .form-control.valid {
        border-color: #28a745;
    }

    .form-control.invalid {
        border-color: #dc3545;
    }

    input:focus {
        outline: none;
        box-shadow: 0 0 3px rgba(0,123,255,.25);
    }
</style>
<body>
    <div class="admin-container">
        {% include 'includes/nav.html' %}

        <div class="main-content">
            <header>
                <h1>Nouvel Organisme</h1>
                <div class="user-info">
                    <a href="{{ url_for('utilisateur.profil') }}" style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 10px;">
                        <span>{{ current_user.nom }}</span>
                        {% if current_user.photo_profil %}
                            <img src="/{{ current_user.photo_profil }}" alt="Photo de profil" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                        {% else %}
                            <i class="fas fa-user-circle" style="font-size: 1.5em;"></i>
                        {% endif %}
                    </a>
                    <a href="{{ url_for('utilisateur.deconnexion') }}" style="margin-left: 10px; color: #dc3545;">
                        <i class="fas fa-sign-out-alt"></i>
                    </a>
                </div>
            </header>

            <div class="content">
                <div class="card">
                    <form method="POST" action="{{ url_for('organisme.create_organisme_user') }}">
                        <!-- Stepper -->
                        <div class="form-stepper">
                            <div class="step active" data-step="1">
                                <div class="step-number">1</div>
                                <div class="step-label">Informations générales</div>
                            </div>
                            <div class="step" data-step="2">
                                <div class="step-number">2</div>
                                <div class="step-label">Coordonnées</div>
                            </div>
                            <div class="step" data-step="3">
                                <div class="step-number">3</div>
                                <div class="step-label">Validation</div>
                            </div>
                        </div>

                        <!-- Tab 1 -->
                        <div class="tab-content active" id="tab-1">
                            <div class="form-section">
                                <h3 class="section-title"><i class="fas fa-info-circle"></i> Informations de base</h3>
                                <div class="form-group">
                                    <label class="required-field">Nom de l'organisme</label>
                                    <input type="text" name="nom" required>
                                </div>
                                <div class="form-group">
                                    <label class="required-field">Présentation</label>
                                    <textarea name="presentation" required rows="4"></textarea>
                                </div>
                                <div class="form-group">
                                    <label class="required-field">Statut juridique</label>
                                    <select name="statut" required>
                                        <option value="">Sélectionnez un statut</option>
                                        <option value="Association loi 1901">Association loi 1901</option>
                                        <option value="Entreprise de droit privé">Entreprise de droit privé (Micro entreprise, SARL...)</option>
                                        <option value="Coopérative">Coopérative</option>
                                        <option value="Etablissement public">Etablissement public</option>
                                        <option value="Collectivité">Collectivité</option>
                                        <option value="Sans">Sans</option>
                                        <option value="Autre">Autre</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <a href="javascript:history.back()" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left"></i> Précédent
                                </a>
                                <button type="button" class="btn btn-primary next-tab" data-next="2">
                                    Suivant <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Tab 2 -->
                        <div class="tab-content" id="tab-2">
                            <div class="form-section">
                                <h3 class="section-title"><i class="fas fa-address-card"></i> Coordonnées</h3>
                                <div class="form-group">
                                    <label class="required-field">Email</label>
                                    <input type="email" name="email" required>
                                </div>
                                <div class="form-group">
                                    <label class="required-field">Téléphone</label>
                                    <input type="tel" name="telephone" required>
                                </div>
                                <div class="form-group">
                                    <label>Site Web</label>
                                    <input type="url" name="site_web">
                                </div>
                            </div>

                            <div class="form-section">
                                <h3 class="section-title"><i class="fas fa-map-marker-alt"></i> Adresse</h3>
                                <div class="form-row" style="gap: 24px;">
                                    <div class="form-group" style="flex: 2;">
                                        <label class="required-field">Adresse</label>
                                        <input type="text" id="rue" name="rue" required placeholder="260 Rue de Charenton">
                                    </div>
                                    <div class="form-group" style="flex: 0.5;">
                                        <label class="required-field">Code postal</label>
                                        <input type="text" 
                                               id="code_postal" 
                                               name="code_postal" 
                                               required
                                               minlength="5"
                                               maxlength="5"
                                               pattern="[0-9]{5}"
                                               inputmode="numeric"
                                               autocomplete="postal-code"
                                               placeholder="75012"
                                               title="Le code postal doit contenir exactement 5 chiffres"
                                               class="form-control">
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label class="required-field">Ville</label>
                                        <input type="text" id="ville" name="ville" required 
                                               pattern="^[A-Za-zÀ-ÿ\s\-']+$"
                                               placeholder="Paris"
                                               title="Seules les lettres, espaces, tirets et apostrophes sont autorisés"
                                               oninput="this.value = this.value.replace(/[^A-Za-zÀ-ÿ\s\-']/g, '');">
                                    </div>
                                </div>
                                <!-- Champ caché pour stocker l'adresse complète -->
                                <input type="hidden" id="adresse_complete" name="adresse">
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary prev-tab" data-prev="1">
                                    <i class="fas fa-arrow-left"></i> Précédent
                                </button>
                                <button type="button" class="btn btn-primary next-tab" data-next="3">
                                    Suivant <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Tab 3 -->
                        <div class="tab-content" id="tab-3">
                            <div class="form-section">
                                <h3 class="section-title"><i class="fas fa-check-circle"></i> Informations complémentaires</h3>
                                <div class="form-group">
                                    <label>Numéro d'adhérent</label>
                                    <input type="text" name="num_adherent">
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <h3 class="section-title"><i class="fas fa-tag"></i> Labels</h3>
                                <div class="checkbox-group" id="labels-group">
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="label_1" name="labels" value="Qualiopi">
                                        <label for="label_1">Qualiopi</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="label_2" name="labels" value="RNCP">
                                        <label for="label_2">RNCP (Répertoire National des Certifications Professionnelles)</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="label_3" name="labels" value="Erasmus+">
                                        <label for="label_3">Erasmus+</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="aucun_label" name="labels" value="aucun">
                                        <label for="aucun_label">Ni label / ni agrément</label>
                                    </div>
                                </div>
                                <div id="labels-error" class="error-message" style="display:none;"></div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary prev-tab" data-prev="2">
                                    <i class="fas fa-arrow-left"></i> Précédent
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-check"></i> Enregistrer l'organisme
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const nextButtons = document.querySelectorAll('.next-tab');
            const prevButtons = document.querySelectorAll('.prev-tab');
            const tabs = document.querySelectorAll('.tab-content');
            const steps = document.querySelectorAll('.step');

            nextButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const currentTab = this.closest('.tab-content');
                    const nextTabId = this.getAttribute('data-next');
                    
                    if (validateTab(currentTab.id)) {
                        currentTab.classList.remove('active');
                        document.getElementById(`tab-${nextTabId}`).classList.add('active');
                        updateStepper(nextTabId);
                    }
                });
            });

            prevButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const currentTab = this.closest('.tab-content');
                    const prevTabId = this.getAttribute('data-prev');
                    currentTab.classList.remove('active');
                    document.getElementById(`tab-${prevTabId}`).classList.add('active');
                    updateStepper(prevTabId);
                });
            });

            function validateTab(tabId) {
                const tab = document.getElementById(tabId);
                let isValid = true;

                // Nettoyer les anciens messages d'erreur
                tab.querySelectorAll('.error-message').forEach(el => el.remove());

                // Validation spécifique pour chaque champ
                if (tabId === 'tab-2') {
                    // Validation Email
                    const emailInput = tab.querySelector('input[name="email"]');
                    if (emailInput) {
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        if (!emailRegex.test(emailInput.value.trim())) {
                            showError(emailInput, "Veuillez entrer une adresse email valide");
                            isValid = false;
                        }
                    }

                    // Validation Téléphone assouplie
                    const telInput = tab.querySelector('input[name="telephone"]');
                    if (telInput) {
                        // Accepte les formats:
                        // - 0XXXXXXXXX
                        // - +33XXXXXXXXX
                        // - 00336XXXXXXXX
                        // - Avec ou sans espaces/points/tirets
                        const telRegex = /^(?:(?:\+|00)33|0)\s*[1-9](?:[\s.-]*\d{2}){4}$/;
                        const cleanNumber = telInput.value.replace(/[\s.-]/g, '');
                        if (!telRegex.test(cleanNumber)) {
                            showError(telInput, "Format attendu : 0X XX XX XX XX ou +33X XX XX XX XX");
                            isValid = false;
                        }
                    }

                    // Validation Code Postal
                    const cpInput = tab.querySelector('input[name="code_postal"]');
                    if (cpInput) {
                        if (!/^\d{5}$/.test(cpInput.value.trim())) {
                            showError(cpInput, "Le code postal doit contenir exactement 5 chiffres");
                            isValid = false;
                        }
                    }

                    // Validation Ville
                    const villeInput = tab.querySelector('input[name="ville"]');
                    if (villeInput) {
                        const villeRegex = /^[A-Za-zÀ-ÿ\s\-']+$/;
                        if (!villeRegex.test(villeInput.value.trim())) {
                            showError(villeInput, "La ville ne doit contenir que des lettres, espaces, tirets et apostrophes");
                            isValid = false;
                        }
                    }

                    // Validation Site Web
                    const siteWebInput = tab.querySelector('input[name="site_web"]');
                    if (siteWebInput && siteWebInput.value.trim()) {
                        const urlRegex = /^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/;
                        if (!urlRegex.test(siteWebInput.value.trim())) {
                            showError(siteWebInput, "Veuillez entrer une URL valide");
                            isValid = false;
                        }
                    }
                }

                // Validation des champs requis
                tab.querySelectorAll('[required]').forEach(input => {
                    if (!input.value.trim()) {
                        showError(input, "Ce champ est obligatoire");
                        isValid = false;
                    }
                });

                return isValid;
            }

            function showError(element, message) {
                // Supprime l'ancien message d'erreur s'il existe
                const existingError = element.parentNode.querySelector('.error-message');
                if (existingError) {
                    existingError.remove();
                }

                // Crée et ajoute le nouveau message d'erreur
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.style.color = 'var(--danger-color)';
                errorDiv.style.fontSize = '0.8rem';
                errorDiv.style.marginTop = '5px';
                errorDiv.textContent = message;
                element.parentNode.appendChild(errorDiv);

                // Ajoute la classe d'erreur à l'input
                element.classList.add('invalid');
                element.classList.remove('valid');
            }

            // Gestion des labels
            const aucunLabelCheckbox = document.getElementById('aucun_label');
            const labelCheckboxes = Array.from(document.querySelectorAll('#labels-group input[type="checkbox"]'))
                .filter(cb => cb.id !== 'aucun_label');

            if (aucunLabelCheckbox) {
                aucunLabelCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        labelCheckboxes.forEach(cb => {
                            cb.checked = false;
                            cb.disabled = true;
                        });
                    } else {
                        labelCheckboxes.forEach(cb => cb.disabled = false);
                    }
                });
            }

            labelCheckboxes.forEach(cb => {
                cb.addEventListener('change', function() {
                    if (this.checked && aucunLabelCheckbox) {
                        aucunLabelCheckbox.checked = false;
                        aucunLabelCheckbox.dispatchEvent(new Event('change'));
                    }
                });
            });

            // Validation spécifique pour le code postal
            const codePostalInput = document.querySelector('input[name="code_postal"]');
            if (codePostalInput) {
                codePostalInput.addEventListener('input', function() {
                    if (this.value.length === 5 && this.validity.valid) {
                        this.style.borderColor = 'var(--success-color)';
                    } else {
                        this.style.borderColor = '';
                    }
                });
            }

            // Validation spécifique pour la ville
            const villeInput = document.querySelector('input[name="ville"]');
            if (villeInput) {
                villeInput.addEventListener('input', function() {
                    if (this.validity.valid && this.value.length > 1) {
                        this.style.borderColor = 'var(--success-color)';
                    } else {
                        this.style.borderColor = '';
                    }
                });
            }

            // Fonction pour mettre à jour l'adresse complète
            function updateAdresseComplete() {
                const rue = document.getElementById('rue').value.trim();
                const codePostal = document.getElementById('code_postal').value.trim();
                const ville = document.getElementById('ville').value.trim();
                
                if (rue && codePostal && ville) {
                    const adresseComplete = `${rue}, ${codePostal} ${ville}`;
                    document.getElementById('adresse_complete').value = adresseComplete;
                }
            }

            // Écouter les changements sur les champs d'adresse
            ['rue', 'code_postal', 'ville'].forEach(id => {
                const input = document.getElementById(id);
                input.addEventListener('input', updateAdresseComplete);
                input.addEventListener('change', updateAdresseComplete);
            });

            // Validation du formulaire avant l'envoi
            document.querySelector('form').addEventListener('submit', function(e) {
                updateAdresseComplete(); // S'assurer que l'adresse est mise à jour avant l'envoi
            });

            // Validation du code postal
            document.getElementById('code_postal').addEventListener('input', function(e) {
                // Ne garder que les chiffres
                this.value = this.value.replace(/[^0-9]/g, '').slice(0, 5);
                
                // Validation visuelle
                if (this.value.length === 5) {
                    this.classList.add('valid');
                    this.classList.remove('invalid');
                } else {
                    this.classList.remove('valid');
                    if (this.value.length > 0) {
                        this.classList.add('invalid');
                    } else {
                        this.classList.remove('invalid');
                    }
                }
            });

            // Validation avant soumission du formulaire
            document.querySelector('form').addEventListener('submit', function(e) {
                const codePostal = document.getElementById('code_postal');
                if (codePostal.value.length !== 5) {
                    e.preventDefault();
                    codePostal.focus();
                    alert('Le code postal doit contenir exactement 5 chiffres');
                }
            });

            function collectLabels() {
                const checked = document.querySelectorAll('#labels-group input[type="checkbox"]:checked');
                const values = Array.from(checked)
                    .filter(cb => cb.id !== 'aucun_label')
                    .map(cb => cb.value)
                    .join(',');
                
                // Mettre à jour le champ caché
                const labelHidden = document.createElement('input');
                labelHidden.type = 'hidden';
                labelHidden.name = 'label';
                labelHidden.value = values;
                
                // Remplacer l'ancien champ caché s'il existe
                const oldHidden = document.querySelector('input[name="label"]');
                if (oldHidden) {
                    oldHidden.replaceWith(labelHidden);
                } else {
                    document.querySelector('form').appendChild(labelHidden);
                }
            }

            // Ajouter les écouteurs d'événements
            document.querySelectorAll('#labels-group input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', collectLabels);
            });
        });
    </script>
    
    <script>
        // Configuration de l'autocomplétion d'adresse pour le formulaire organisme
        function setupAddressAutocomplete() {
            const adresseInput = document.getElementById('rue');
            const codePostalInput = document.getElementById('code_postal');
            const villeInput = document.getElementById('ville');
            
            let timeoutId = null;

            adresseInput.addEventListener('input', function() {
                // Annuler la requête précédente si elle existe
                if (timeoutId) clearTimeout(timeoutId);
                
                const searchText = this.value.trim();
                if (searchText.length < 3) return;

                // Délai de 300ms avant d'envoyer la requête
                timeoutId = setTimeout(() => {
                    const url = `https://data.geopf.fr/geocodage/completion?text=${encodeURIComponent(searchText)}&type=StreetAddress`;
                    
                    fetch(url)
                        .then(response => response.json())
                        .then(data => {
                            if (data.results && data.results.length > 0) {
                                showSuggestions(data.results, adresseInput, codePostalInput, villeInput);
                            }
                        })
                        .catch(error => console.error('Erreur:', error));
                }, 300);
            });
        }

        // Affichage des suggestions
        function showSuggestions(results, adresseInput, codePostalInput, villeInput) {
            // Supprimer l'ancienne liste de suggestions si elle existe
            let suggestionList = document.getElementById('address-suggestions');
            if (suggestionList) {
                suggestionList.remove();
            }

            // Créer la nouvelle liste de suggestions
            suggestionList = document.createElement('ul');
            suggestionList.id = 'address-suggestions';
            suggestionList.className = 'suggestions-list';

            results.forEach(result => {
                const li = document.createElement('li');
                li.textContent = result.fulltext;
                li.addEventListener('click', () => {
                    // Remplir les champs avec les données de l'adresse sélectionnée
                    const parts = result.fulltext.split(',');
                    if (parts.length >= 2) {
                        adresseInput.value = parts[0].trim();
                        const postalAndCity = parts[1].trim().match(/(\d{5})\s+(.*)/);
                        if (postalAndCity) {
                            codePostalInput.value = postalAndCity[1];
                            villeInput.value = postalAndCity[2];
                        }
                    }
                    suggestionList.remove();
                    updateAdresseComplete(); // Mettre à jour l'adresse complète
                });
                suggestionList.appendChild(li);
            });

            // Positionner la liste sous le champ d'adresse
            adresseInput.parentNode.style.position = 'relative';
            adresseInput.parentNode.appendChild(suggestionList);
        }

        // Autocomplétion pour le code postal et la ville
        const villeSuggestionList = document.createElement('ul');
        villeSuggestionList.className = 'suggestions-list';

        function clearSuggestions() {
            villeSuggestionList.innerHTML = '';
            if (villeSuggestionList.parentNode) {
                villeSuggestionList.parentNode.removeChild(villeSuggestionList);
            }
        }

        // Quand on tape un code postal
        document.getElementById('code_postal').addEventListener('input', function () {
            const cp = this.value;

            clearSuggestions();

            if (/^\d{4,5}$/.test(cp)) {
                fetch(`https://api-adresse.data.gouv.fr/search/?q=${cp}&limit=10`)
                    .then(res => res.json())
                    .then(data => {
                        const villes = new Set();
                        data.features.forEach(f => {
                            const city = f.properties.city || f.properties.label;
                            if (city) villes.add(city);
                        });

                        if (villes.size > 0) {
                            villes.forEach(ville => {
                                const li = document.createElement('li');
                                li.textContent = ville;
                                li.style.padding = '8px';
                                li.style.cursor = 'pointer';
                                li.addEventListener('click', () => {
                                    document.getElementById('ville').value = ville;
                                    clearSuggestions();
                                    updateAdresseComplete();
                                });
                                villeSuggestionList.appendChild(li);
                            });
                            this.parentNode.appendChild(villeSuggestionList);
                        }
                    })
                    .catch(console.error);
            }
        });

        // Quand on tape une ville
        document.getElementById('ville').addEventListener('input', function () {
            const ville = this.value.trim();

            clearSuggestions();

            if (ville.length >= 3) {
                fetch(`https://api-adresse.data.gouv.fr/search/?q=${ville}&type=municipality&limit=10`)
                    .then(res => res.json())
                    .then(data => {
                        const added = new Set();

                        data.features.forEach(f => {
                            const city = f.properties.city;
                            const cp = f.properties.postcode;

                            const key = `${city} ${cp}`;
                            if (!added.has(key)) {
                                added.add(key);
                                const li = document.createElement('li');
                                li.textContent = `${city} (${cp})`;
                                li.style.padding = '8px';
                                li.style.cursor = 'pointer';
                                li.addEventListener('click', () => {
                                    this.value = city;
                                    document.getElementById('code_postal').value = cp;
                                    clearSuggestions();
                                    updateAdresseComplete();
                                });
                                villeSuggestionList.appendChild(li);
                            }
                        });

                        if (added.size > 0) {
                            this.parentNode.appendChild(villeSuggestionList);
                        }
                    })
                    .catch(console.error);
            }
        });

        // Fermer les suggestions quand on clique ailleurs
        document.addEventListener('click', (e) => {
            if (!villeSuggestionList.contains(e.target)) {
                clearSuggestions();
            }
        });

        // Initialiser l'autocomplétion au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            setupAddressAutocomplete();
        });
    </script>
</body>
</html>