<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

    <div class="flash-popup-container" id="flashPopupContainer">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-popup flash-{{ category }}">
                        {{ message }}
                        <span class="close-btn" onclick="this.parentElement.style.display='none';">&times;</span>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <div class="admin-container">
        {% include 'includes/nav.html' %}
        
        <!-- Main Content -->
        <div class="main-content">
            <header>
                <h1>Tableau de bord</h1>
                <div class="user-info">
                    <a href="{{ url_for('utilisateur.profil') }}" style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 10px;">
                        <span>{{ user.nom }}</span>
                        {% if user.photo_profil %}
                            <img src="/{{ user.photo_profil }}"
                                alt="Photo de profil" 
                                style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                        {% else %}
                            <i class="fas fa-user-circle" style="font-size: 1.5em;"></i>
                        {% endif %}
                    </a>
                    <a href="{{ url_for('utilisateur.deconnexion') }}" style="margin-left: 10px; color: #dc3545;">
                        <i class="fas fa-sign-out-alt"></i>
                    </a>
                </div>
            </header>

            <div class="content">
                {% if user.role == 'admin' %}
                    <!-- Organismes Section -->
                    <section class="card">
                        <h2><i class="fas fa-building icon"></i> Organismes enregistrés (<span id="countOrganismes">{{ nb_organismes }}</span>)</h2>
                        <div class="actions">
                            <button id="btnToggleOrganismes" class="btn">
                                <i class="fas fa-eye"></i> Voir les organismes
                            </button>
                            <a href="{{ url_for('organisme.edit_organismes') }}" class="btn btn-manage">
                                <i class="fas fa-cog"></i> Gérer les organismes
                            </a>
                        </div>

                        <div class="pagination-controls" id="paginationOrganismesTop" style="display:none;">
                            <span id="itemCountOrganismes">Affichage de {{ organismes|length }} organismes</span>
                            <div class="pagination-buttons">
                                <button class="btn" id="prevPageOrganismes"><i class="fas fa-chevron-left"></i> Précédent</button>
                                <span id="pageInfoOrganismes">Page 1</span>
                                <button class="btn" id="nextPageOrganismes">Suivant <i class="fas fa-chevron-right"></i></button>
                            </div>
                            <select id="itemsPerPageOrganismes">
                                <option value="10">10 par page</option>
                                <option value="25">25 par page</option>
                                <option value="50">50 par page</option>
                                <option value="100">100 par page</option>
                            </select>
                        </div>

                        <table id="tableOrganismes" class="table" style="display: none;">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nom</th>
                                    <th>Adresse</th>
                                    <th>Email</th>
                                    <th>Téléphone</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for o in organismes %}
                                <tr class="organisme-row">
                                    <td>{{ o.id_organisme }}</td>
                                    <td>{{ o.nom }}</td>
                                    <td>{{ o.adresse }}</td>
                                    <td>{{ o.email }}</td>
                                    <td>{{ o.telephone }}</td>
                                    <td>
                                        <a href="{{ url_for('organisme.preview_organisme', id=o.id_organisme) }}" class="btn-details" title="Voir">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>

                        <div class="pagination-controls" id="paginationOrganismesBottom" style="display:none;">
                            <span id="itemCountOrganismesBottom">Affichage de {{ organismes|length }} organismes</span>
                            <div class="pagination-buttons">
                                <button class="btn" id="prevPageOrganismesBottom"><i class="fas fa-chevron-left"></i> Précédent</button>
                                <span id="pageInfoOrganismesBottom">Page 1</span>
                                <button class="btn" id="nextPageOrganismesBottom">Suivant <i class="fas fa-chevron-right"></i></button>
                            </div>
                        </div>

                        <div class="export-buttons" id="exportOrganismes" style="display: none;">
                            <button class="btn" onclick="exportTable('tableOrganismes', 'csv', 'organismes')">Exporter CSV</button>
                            <button class="btn" onclick="exportTable('tableOrganismes', 'json', 'organismes')">Exporter JSON</button>
                        </div>
                    </section>

                    <!-- Formations Section -->
                    <section class="card">
                        <h2><i class="fas fa-graduation-cap icon"></i> Formations enregistrées (<span id="countFormations">{{ nb_formations }}</span>)</h2>
                        <div class="actions">
                            <button id="btnToggleFormations" class="btn">
                                <i class="fas fa-eye"></i> Voir les formations
                            </button>
                            <a href="{{ url_for('formation.edit_formations') }}" class="btn btn-manage">
                                <i class="fas fa-cog"></i> Gérer les formations
                            </a>
                        </div>

                        <div class="pagination-controls" id="paginationFormationsTop" style="display:none;">
                            <span id="itemCountFormations">Affichage de {{ formations|length }} formations</span>
                            <div class="pagination-buttons">
                                <button class="btn" id="prevPageFormations"><i class="fas fa-chevron-left"></i> Précédent</button>
                                <span id="pageInfoFormations">Page 1</span>
                                <button class="btn" id="nextPageFormations">Suivant <i class="fas fa-chevron-right"></i></button>
                            </div>
                            <select id="itemsPerPageFormations">
                                <option value="10">10 par page</option>
                                <option value="25">25 par page</option>
                                <option value="50">50 par page</option>
                                <option value="100">100 par page</option>
                            </select>
                        </div>

                        <table id="tableFormations" class="table" style="display: none;">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nom</th>
                                    <th>Type</th>
                                    <th>Description</th>
                                    <th>Durée</th>
                                    <th>Lieu</th>
                                    <th>Prix</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for f in formations %}
                                <tr class="formation-row">
                                    <td>{{ f.id_formation }}</td>
                                    <td>{{ f.nom }}</td>
                                    <td>{{ 'Initiale' if f.type == 'initiale' else 'Continue' }}</td>
                                    <td>{{ f.description }}</td>
                                    <td>{{ f.duree }}</td>
                                    <td>{{ f.lieu }}</td>
                                    <td>{% if f.prix %}{{ "%.2f"|format(f.prix) }} €{% endif %}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>

                        <div class="pagination-controls" id="paginationFormationsBottom" style="display:none;">
                            <span id="itemCountFormationsBottom">Affichage de {{ formations|length }} formations</span>
                            <div class="pagination-buttons">
                                <button class="btn" id="prevPageFormationsBottom"><i class="fas fa-chevron-left"></i> Précédent</button>
                                <span id="pageInfoFormationsBottom">Page 1</span>
                                <button class="btn" id="nextPageFormationsBottom">Suivant <i class="fas fa-chevron-right"></i></button>
                            </div>
                        </div>

                        <div class="export-buttons" id="exportFormations" style="display: none;">
                            <button class="btn" onclick="exportTable('tableFormations', 'csv', 'formations')">Exporter CSV</button>
                            <button class="btn" onclick="exportTable('tableFormations', 'json', 'formations')">Exporter JSON</button>
                        </div>
                    </section>

                {% elif user.role == 'user' %}
                    <section class="user-dashboard">
                        <div class="user-welcome-card">
                            <h2>Bienvenue, {{ user.nom }} !</h2>
                            {% if user.id_organisme %}
                                <p class="user-organisme">
                                    <i class="fas fa-building"></i> 
                                    Organisme : <strong>{{ user.organisme.nom }}</strong>
                                </p>
                            {% else %}
                                <p class="user-organisme warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    Vous n'êtes pas encore associé à un organisme, allez dans votre profil pour en ajouter un.
                                </p>
                            {% endif %}
                        </div>

                        {% if user.id_organisme %}
                            <div class="user-formations-header">
                                <h2><i class="fas fa-graduation-cap"></i> Vos formations</h2>
                                <a href="{{ url_for('formation.formulaire') }}" class="btn btn-add">
                                    <i class="fas fa-plus"></i> Ajouter une formation
                                </a>
                            </div>

                            {% if formations %}
                                <div class="user-formations-grid">
                                    {% for formation in formations %}
                                        <div class="user-formation-card">
                                            <div class="user-formation-header">
                                                <h3>{{ formation.nom }}</h3>
                                                <span class="user-formation-type {{ formation.type }}">
                                                    {{ 'Initiale' if formation.type == 'initiale' else 'Continue' }}
                                                </span>
                                            </div>
                                            
                                            <div class="user-formation-details">
                                                <p><i class="fas fa-calendar-alt"></i> {{ formation.dates }}</p>
                                                <p><i class="fas fa-clock"></i> {{ formation.duree }}</p>
                                                <p><i class="fas fa-map-marker-alt"></i> {{ formation.lieu }}</p>
                                                {% if formation.prix %}
                                                    <p><i class="fas fa-euro-sign"></i> {{ "%.2f"|format(formation.prix) }} €</p>
                                                {% endif %}
                                            </div>
                                            
                                            <div class="user-formation-status">
                                                <span class="status-badge {{ formation.etat }}">
                                                    {{ 'Validée' if formation.etat == 'valide' else 'En attente' }}
                                                </span>
                                            </div>
                                            
                                            <div class="user-formation-actions">
                                                <a href="{{ url_for('formation.modify_formation', id=formation.id_formation) }}" class="btn btn-edit">
                                                    <i class="fas fa-edit"></i> Modifier
                                                </a>
                                                <button class="btn btn-delete" onclick="showDeleteModal('{{ formation.id_formation }}')">
                                                    <i class="fas fa-trash-alt"></i> Supprimer
                                                </button>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="user-no-formations">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <h3>Vous n'avez pas encore ajouté de formation</h3>
                                    <p>Commencez par ajouter votre première formation en cliquant sur le bouton ci-dessus</p>
                                    <a href="{{ url_for('formation.formulaire') }}" class="btn btn-primary">
                                        <i class="fas fa-plus"></i> Ajouter une formation
                                    </a>
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="user-formations-header">
                                <h2><i class="fas fa-graduation-cap"></i> Vos formations</h2>
                                <a href="{{ url_for('utilisateur.profil', _anchor='organisme-section') }}" class="btn-associate">
                                    <i class="fas fa-link"></i>
                                    Associer un organisme pour gérer vos formations
                                </a>
                            </div>
                        {% endif %}
                    </section>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Modal de suppression -->
    <div id="deleteModal" class="modal-overlay" style="display: none;">
        <div class="modal-box">
            <h3>Confirmation de suppression</h3>
            <p>Veuillez indiquer la raison de la suppression :</p>
            <form id="deleteForm" action="{{ url_for('formation.delete_with_reason') }}" method="POST">
                <input type="hidden" id="deleteFormationId" name="id">
                <textarea 
                    id="deleteReason" 
                    name="reason" 
                    rows="4" 
                    maxlength="1000" 
                    required
                    placeholder="Veuillez expliquer la raison de la suppression..."
                    style="resize: none;"
                ></textarea>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hideDeleteModal()">Annuler</button>
                    <button type="submit" class="btn btn-danger">Confirmer la suppression</button>
                </div>
            </form>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
    function showDeleteModal(formationId) {
        const modal = document.getElementById('deleteModal');
        document.getElementById('deleteFormationId').value = formationId;
        document.getElementById('deleteReason').value = '';
        modal.style.display = 'flex';
    }

    function hideDeleteModal() {
        const modal = document.getElementById('deleteModal');
        modal.style.display = 'none';
    }

    // Fermer le modal si on clique en dehors
    window.onclick = function(event) {
        const modal = document.getElementById('deleteModal');
        if (event.target === modal) {
            hideDeleteModal();
        }
    }

    function paginateTable(tableId, itemsPerPage, page, rowClass) {
        const table = document.getElementById(tableId);
        if (!table) return;
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        const totalRows = rows.length;
        const totalPages = Math.max(1, Math.ceil(totalRows / itemsPerPage));
        page = Math.max(1, Math.min(page, totalPages));
        rows.forEach((row, idx) => {
            row.style.display = (idx >= (page - 1) * itemsPerPage && idx < page * itemsPerPage) ? '' : 'none';
        });
        return { totalRows, totalPages, page };
    }

    function setupPagination(tableId, topControlsId, bottomControlsId, itemsPerPageId, rowClass, itemCountId, pageInfoId, prevBtnId, nextBtnId, itemCountBottomId, pageInfoBottomId, prevBtnBottomId, nextBtnBottomId) {
        let currentPage = 1;
        let itemsPerPage = parseInt(document.getElementById(itemsPerPageId).value);

        function update() {
            const { totalRows, totalPages, page } = paginateTable(tableId, itemsPerPage, currentPage, rowClass);
            document.getElementById(itemCountId).textContent = `Affichage de ${totalRows} ${rowClass === 'organisme-row' ? 'organismes' : 'formations'}`;
            document.getElementById(pageInfoId).textContent = `Page ${page} sur ${totalPages}`;
            document.getElementById(itemCountBottomId).textContent = `Affichage de ${totalRows} ${rowClass === 'organisme-row' ? 'organismes' : 'formations'}`;
            document.getElementById(pageInfoBottomId).textContent = `Page ${page} sur ${totalPages}`;
            document.getElementById(prevBtnId).disabled = page === 1;
            document.getElementById(nextBtnId).disabled = page === totalPages;
            document.getElementById(prevBtnBottomId).disabled = page === 1;
            document.getElementById(nextBtnBottomId).disabled = page === totalPages;
        }

        document.getElementById(itemsPerPageId).addEventListener('change', function() {
            itemsPerPage = parseInt(this.value);
            currentPage = 1;
            update();
        });
        document.getElementById(prevBtnId).addEventListener('click', function() {
            if (currentPage > 1) { currentPage--; update(); }
        });
        document.getElementById(nextBtnId).addEventListener('click', function() {
            currentPage++; update();
        });
        document.getElementById(prevBtnBottomId).addEventListener('click', function() {
            if (currentPage > 1) { currentPage--; update(); }
        });
        document.getElementById(nextBtnBottomId).addEventListener('click', function() {
            currentPage++; update();
        });

        update();
        return update;
    }

    // Voir/Cacher Organismes
    const btnToggleOrganismes = document.getElementById('btnToggleOrganismes');
    const tableOrganismes = document.getElementById('tableOrganismes');
    const exportOrganismes = document.getElementById('exportOrganismes');
    const paginationOrganismesTop = document.getElementById('paginationOrganismesTop');
    const paginationOrganismesBottom = document.getElementById('paginationOrganismesBottom');
    let organismesVisible = false;
    let updateOrganismesPagination = null;

    btnToggleOrganismes.addEventListener('click', function() {
        organismesVisible = !organismesVisible;
        tableOrganismes.style.display = organismesVisible ? '' : 'none';
        exportOrganismes.style.display = organismesVisible ? '' : 'none';
        paginationOrganismesTop.style.display = organismesVisible ? '' : 'none';
        paginationOrganismesBottom.style.display = organismesVisible ? '' : 'none';
        btnToggleOrganismes.innerHTML = organismesVisible ? '<i class="fas fa-eye-slash"></i> Cacher les organismes' : '<i class="fas fa-eye"></i> Voir les organismes';
        if (organismesVisible && !updateOrganismesPagination) {
            updateOrganismesPagination = setupPagination(
                'tableOrganismes', 'paginationOrganismesTop', 'paginationOrganismesBottom', 'itemsPerPageOrganismes',
                'organisme-row', 'itemCountOrganismes', 'pageInfoOrganismes', 'prevPageOrganismes', 'nextPageOrganismes',
                'itemCountOrganismesBottom', 'pageInfoOrganismesBottom', 'prevPageOrganismesBottom', 'nextPageOrganismesBottom'
            );
        } else if (organismesVisible && updateOrganismesPagination) {
            updateOrganismesPagination();
        }
    });

    // Voir/Cacher Formations
    const btnToggleFormations = document.getElementById('btnToggleFormations');
    const tableFormations = document.getElementById('tableFormations');
    const exportFormations = document.getElementById('exportFormations');
    const paginationFormationsTop = document.getElementById('paginationFormationsTop');
    const paginationFormationsBottom = document.getElementById('paginationFormationsBottom');
    let formationsVisible = false;
    let updateFormationsPagination = null;

    btnToggleFormations.addEventListener('click', function() {
        formationsVisible = !formationsVisible;
        tableFormations.style.display = formationsVisible ? '' : 'none';
        exportFormations.style.display = formationsVisible ? '' : 'none';
        paginationFormationsTop.style.display = formationsVisible ? '' : 'none';
        paginationFormationsBottom.style.display = formationsVisible ? '' : 'none';
        btnToggleFormations.innerHTML = formationsVisible ? '<i class="fas fa-eye-slash"></i> Cacher les formations' : '<i class="fas fa-eye"></i> Voir les formations';
        if (formationsVisible && !updateFormationsPagination) {
            updateFormationsPagination = setupPagination(
                'tableFormations', 'paginationFormationsTop', 'paginationFormationsBottom', 'itemsPerPageFormations',
                'formation-row', 'itemCountFormations', 'pageInfoFormations', 'prevPageFormations', 'nextPageFormations',
                'itemCountFormationsBottom', 'pageInfoFormationsBottom', 'prevPageFormationsBottom', 'nextPageFormationsBottom'
            );
        } else if (formationsVisible && updateFormationsPagination) {
            updateFormationsPagination();
        }
    });
    </script>

    <style>
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-box {
        background: white;
        padding: 25px;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
    }

    .modal-box h3 {
        margin: 0 0 15px 0;
        color: #333;
    }

    .modal-box textarea {
        width: 100%;
        padding: 10px;
        margin: 10px 0 20px 0;
        border: 2px solid #ddd;
        border-radius: 4px;
        font-family: inherit;
    }

    .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .btn-danger {
        background-color: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background-color: #c82333;
    }
    </style>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Gestion des onglets
        const tabButtons = document.querySelectorAll('.options-tab-buttons .tab-btn');
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // Désactive tous les onglets
                document.querySelectorAll('.options-tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                tabButtons.forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Active l'onglet sélectionné
                this.classList.add('active');
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });
        
        // Gestion de l'ajout d'options
        const addForms = document.querySelectorAll('.add-option-form');
        addForms.forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const type = this.getAttribute('data-type');
                const value = this.querySelector('input').value.trim();

                if (value) {
                    fetch('/admin/add-option', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ type, value })
                    })
                    .then(async response => {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            return response.json();
                        } else {
                            throw new Error('Réponse non JSON du serveur');
                        }
                    })
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('Erreur: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Une erreur est survenue: ' + error.message);
                    });
                }
            });
        });

        // Gestion de la suppression d'options
        document.querySelectorAll('.btn-delete-option').forEach(button => {
            button.addEventListener('click', function() {
                const type = this.getAttribute('data-type');
                const value = this.getAttribute('data-value');

                if (confirm(`Êtes-vous sûr de vouloir supprimer "${value}" ?`)) {
                    fetch('/admin/delete-option', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ type, value })
                    })
                    .then(async response => {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            return response.json();
                        } else {
                            throw new Error('Réponse non JSON du serveur');
                        }
                    })
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('Erreur: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Une erreur est survenue: ' + error.message);
                    });
                }
            });
        });

        // Gestion de l'édition d'options
        document.querySelectorAll('.btn-edit-option').forEach(button => {
            button.addEventListener('click', function() {
                const type = this.getAttribute('data-type');
                const oldValue = this.getAttribute('data-value');
                const newValue = prompt(`Modifier ${type} "${oldValue}" :`, oldValue);

                if (newValue && newValue !== oldValue) {
                    fetch('/admin/update-option', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ type, oldValue, newValue })
                    })
                    .then(async response => {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            return response.json();
                        } else {
                            throw new Error('Réponse non JSON du serveur');
                        }
                    })
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('Erreur: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Une erreur est survenue: ' + error.message);
                    });
                }
            });
        });
    });
    </script>
</body>
</html>