<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

    <div class="flash-popup-container" id="flashPopupContainer">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-popup flash-{{ category }}">
                        {{ message }}
                        <span class="close-btn" onclick="this.parentElement.style.display='none';">&times;</span>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <div class="admin-container">
        {% include 'includes/nav.html' %}
        
        <!-- Main Content -->
        <div class="main-content">
            <header>
                <h1>Tableau de bord</h1>
                <div class="user-info">
                    <a href="{{ url_for('utilisateur.profil') }}" style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 10px;">
                        <span>{{ user.nom }}</span>
                        {% if user.photo_profil %}
                            <img src="/{{ user.photo_profil }}"
                                alt="Photo de profil" 
                                style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                        {% else %}
                            <i class="fas fa-user-circle" style="font-size: 1.5em;"></i>
                        {% endif %}
                    </a>
                    <a href="{{ url_for('utilisateur.deconnexion') }}" style="margin-left: 10px; color: #dc3545;">
                        <i class="fas fa-sign-out-alt"></i>
                    </a>
                </div>
            </header>

            <div class="content">
                {% if user.role == 'admin' %}
                <div class="admin-dashboard">
                    <!-- Vue d'ensemble statistiques -->
                    <section class="stats-overview">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon"><i class="fas fa-building"></i></div>
                                <div class="stat-info">
                                    <h3>Organismes</h3>
                                    <p class="stat-count">{{ nb_organismes }}</p>
                                </div>
                                <div class="stat-actions">
                                    <a href="{{ url_for('organisme.edit_organismes') }}" class="btn-manage">
                                        <i class="fas fa-cog"></i> Gérer
                                    </a>
                                </div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-icon"><i class="fas fa-graduation-cap"></i></div>
                                <div class="stat-info">
                                    <h3>Formations</h3>
                                    <p class="stat-count">{{ nb_formations }}</p>
                                    <div class="stat-details">
                                        <p class="stat-detail">
                                            <i class="fas fa-clock"></i> 
                                            {{ formations|selectattr('etat', 'equalto', 'en_attente')|list|length }} en attente
                                        </p>
                                        <p class="stat-detail">
                                            <i class="fas fa-check-circle"></i> 
                                            {{ formations|selectattr('etat', 'equalto', 'valide')|list|length }} validées
                                        </p>
                                    </div>
                                </div>
                                <div class="stat-actions">
                                    <a href="{{ url_for('formation.edit_formations') }}" class="btn-manage">
                                        <i class="fas fa-cog"></i> Gérer
                                    </a>
                                </div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-icon"><i class="fas fa-users"></i></div>
                                <div class="stat-info">
                                    <h3>Utilisateurs</h3>
                                    <p class="stat-count">{{ nb_users }}</p>
                                    <p class="stat-detail">{{ users|selectattr('role', 'equalto', 'admin')|list|length }} administrateurs</p>
                                </div>
                                <div class="stat-actions">
                                    <a href="{{ url_for('utilisateur.edit_utilisateurs') }}" class="btn-manage">
                                        <i class="fas fa-cog"></i> Gérer
                                    </a>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Export des données -->
                    <section class="export-section">
                        <h2><i class="fas fa-download"></i> Exporter les données</h2>
                        <div class="export-grid">
                            <div class="export-card">
                                <h3>Organismes</h3>
                                <div class="export-actions">
                                    <button onclick="exportData('organismes', 'csv')" class="btn-export">
                                        <i class="fas fa-file-csv"></i> CSV
                                    </button>
                                    <button onclick="exportData('organismes', 'json')" class="btn-export">
                                        <i class="fas fa-file-code"></i> JSON
                                    </button>
                                </div>
                            </div>

                            <div class="export-card">
                                <h3>Formations</h3>
                                <div class="export-actions">
                                    <button onclick="exportData('formations', 'csv')" class="btn-export">
                                        <i class="fas fa-file-csv"></i> CSV
                                    </button>
                                    <button onclick="exportData('formations', 'json')" class="btn-export">
                                        <i class="fas fa-file-code"></i> JSON
                                    </button>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>

                <style>
                .admin-dashboard {
                    padding: 2rem;
                    max-width: 1200px;
                    margin: 0 auto;
                }

                .stats-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                    gap: 2rem;
                    margin-bottom: 3rem;
                }

                .stat-card {
                    background: white;
                    border-radius: 12px;
                    padding: 1.5rem;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                    display: flex;
                    align-items: center;
                    transition: transform 0.2s;
                }

                .stat-card:hover {
                    transform: translateY(-5px);
                }

                .stat-icon {
                    background: #4a90e2;
                    color: white;
                    width: 60px;
                    height: 60px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 1.5rem;
                    margin-right: 1.5rem;
                }

                .stat-info {
                    flex-grow: 1;
                }

                .stat-info h3 {
                    margin: 0;
                    color: #2c3e50;
                    font-size: 1.1rem;
                }

                .stat-count {
                    font-size: 2.5rem;
                    font-weight: bold;
                    color: #2c3e50;
                    margin: 0.5rem 0;
                }

                .stat-detail {
                    font-size: 0.9rem;
                    color: #666;
                    margin: 0;
                }

                .stat-details {
                    margin-top: 0.5rem;
                }

                .stat-actions {
                    margin-left: auto;
                }

                .btn-manage {
                    background: #4a90e2;
                    color: white;
                    padding: 0.5rem 1rem;
                    border-radius: 6px;
                    text-decoration: none;
                    display: inline-flex;
                    align-items: center;
                    gap: 0.5rem;
                    transition: background 0.2s;
                }

                .btn-manage:hover {
                    background: #357abd;
                }

                .export-section {
                    background: white;
                    border-radius: 12px;
                    padding: 2rem;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                }

                .export-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                    gap: 2rem;
                    margin-top: 1.5rem;
                }

                .export-card {
                    background: #f8f9fa;
                    padding: 1.5rem;
                    border-radius: 8px;
                    text-align: center;
                }

                .export-actions {
                    display: flex;
                    gap: 1rem;
                    justify-content: center;
                    margin-top: 1rem;
                }

                .btn-export {
                    padding: 0.5rem 1rem;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    transition: all 0.2s;
                }

                .btn-export:first-child {
                    background: #28a745;
                    color: white;
                }

                .btn-export:last-child {
                    background: #17a2b8;
                    color: white;
                }

                .btn-export:hover {
                    opacity: 0.9;
                    transform: translateY(-2px);
                }
                </style>

                <script>
                function exportData(type, format) {
                    const loadingIndicator = document.createElement('div');
                    loadingIndicator.className = 'loading-indicator';
                    loadingIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Export en cours...';
                    document.body.appendChild(loadingIndicator);

                    fetch(`/export/${type}/${format}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Erreur lors de l\'export');
                            }
                            return response.blob();
                        })
                        .then(blob => {
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.style.display = 'none';
                            a.href = url;
                            a.download = `${type}_export.${format}`;
                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(url);
                            a.remove();
                            loadingIndicator.remove();
                        })
                        .catch(error => {
                            console.error('Erreur:', error);
                            alert('Une erreur est survenue lors de l\'export');
                            loadingIndicator.remove();
                        });
                }
                </script>


                {% elif user.role == 'user' %}
                    <section class="user-dashboard">
                        <div class="user-welcome-card">
                            <h2>Bienvenue, {{ user.nom }} !</h2>
                            {% if user.id_organisme %}
                                <p class="user-organisme">
                                    <i class="fas fa-building"></i> 
                                    Organisme : <strong>{{ user.organisme.nom }}</strong>
                                </p>
                            {% else %}
                                <p class="user-organisme warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    Vous n'êtes pas encore associé à un organisme, allez dans votre profil pour en ajouter un.
                                </p>
                            {% endif %}
                        </div>

                        {% if user.id_organisme %}
                            <div class="user-formations-header">
                                <h2><i class="fas fa-graduation-cap"></i> Vos formations</h2>
                                <a href="{{ url_for('formation.formulaire') }}" class="btn btn-add">
                                    <i class="fas fa-plus"></i> Ajouter une formation
                                </a>
                            </div>

                            {% if formations %}
                                <div class="user-formations-grid">
                                    {% for formation in formations %}
                                        <div class="user-formation-card">
                                            <div class="user-formation-header">
                                                <h3>{{ formation.nom }}</h3>
                                                <span class="user-formation-type {{ formation.type }}">
                                                    {{ 'Initiale' if formation.type == 'initiale' else 'Continue' }}
                                                </span>
                                            </div>
                                            
                                            <div class="user-formation-details">
                                                <p><i class="fas fa-calendar-alt"></i> {{ formation.dates }}</p>
                                                <p><i class="fas fa-clock"></i> {{ formation.duree }}</p>
                                                <p><i class="fas fa-map-marker-alt"></i> {{ formation.lieu }}</p>
                                                {% if formation.prix %}
                                                    <p><i class="fas fa-euro-sign"></i> {{ "%.2f"|format(formation.prix) }} €</p>
                                                {% endif %}
                                            </div>
                                            
                                            <div class="user-formation-status">
                                                <span class="status-badge {{ formation.etat }}">
                                                    {{ 'Validée' if formation.etat == 'valide' else 'En attente' }}
                                                </span>
                                            </div>
                                            
                                            <div class="user-formation-actions">
                                                <a href="{{ url_for('formation.modify_formation', id=formation.id_formation) }}" class="btn btn-edit">
                                                    <i class="fas fa-edit"></i> Modifier
                                                </a>
                                                <button class="btn btn-delete" onclick="showDeleteModal('{{ formation.id_formation }}')">
                                                    <i class="fas fa-trash-alt"></i> Supprimer
                                                </button>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="user-no-formations">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <h3>Vous n'avez pas encore ajouté de formation</h3>
                                    <p>Commencez par ajouter votre première formation en cliquant sur le bouton ci-dessus</p>
                                    <a href="{{ url_for('formation.formulaire') }}" class="btn btn-primary">
                                        <i class="fas fa-plus"></i> Ajouter une formation
                                    </a>
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="user-formations-header">
                                <h2><i class="fas fa-graduation-cap"></i> Vos formations</h2>
                                <a href="{{ url_for('utilisateur.profil', _anchor='organisme-section') }}" class="btn-associate">
                                    <i class="fas fa-link"></i>
                                    Associer un organisme pour gérer vos formations
                                </a>
                            </div>
                        {% endif %}
                    </section>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Modal de suppression -->
    <div id="deleteModal" class="modal-overlay" style="display: none;">
        <div class="modal-box">
            <h3>Confirmation de suppression</h3>
            <p>Veuillez indiquer la raison de la suppression :</p>
            <form id="deleteForm" action="{{ url_for('formation.delete_with_reason') }}" method="POST">
                <input type="hidden" id="deleteFormationId" name="id">
                <textarea 
                    id="deleteReason" 
                    name="reason" 
                    rows="4" 
                    maxlength="1000" 
                    required
                    placeholder="Veuillez expliquer la raison de la suppression..."
                    style="resize: none;"
                ></textarea>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hideDeleteModal()">Annuler</button>
                    <button type="submit" class="btn btn-danger">Confirmer la suppression</button>
                </div>
            </form>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
    function showDeleteModal(formationId) {
        const modal = document.getElementById('deleteModal');
        document.getElementById('deleteFormationId').value = formationId;
        document.getElementById('deleteReason').value = '';
        modal.style.display = 'flex';
    }

    function hideDeleteModal() {
        const modal = document.getElementById('deleteModal');
        modal.style.display = 'none';
    }

    // Fermer le modal si on clique en dehors
    window.onclick = function(event) {
        const modal = document.getElementById('deleteModal');
        if (event.target === modal) {
            hideDeleteModal();
        }
    }

    function paginateTable(tableId, itemsPerPage, page, rowClass) {
        const table = document.getElementById(tableId);
        if (!table) return;
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        const totalRows = rows.length;
        const totalPages = Math.max(1, Math.ceil(totalRows / itemsPerPage));
        page = Math.max(1, Math.min(page, totalPages));
        rows.forEach((row, idx) => {
            row.style.display = (idx >= (page - 1) * itemsPerPage && idx < page * itemsPerPage) ? '' : 'none';
        });
        return { totalRows, totalPages, page };
    }

    function setupPagination(tableId, topControlsId, bottomControlsId, itemsPerPageId, rowClass, itemCountId, pageInfoId, prevBtnId, nextBtnId, itemCountBottomId, pageInfoBottomId, prevBtnBottomId, nextBtnBottomId) {
        let currentPage = 1;
        let itemsPerPage = parseInt(document.getElementById(itemsPerPageId).value);

        function update() {
            const { totalRows, totalPages, page } = paginateTable(tableId, itemsPerPage, currentPage, rowClass);
            document.getElementById(itemCountId).textContent = `Affichage de ${totalRows} ${rowClass === 'organisme-row' ? 'organismes' : 'formations'}`;
            document.getElementById(pageInfoId).textContent = `Page ${page} sur ${totalPages}`;
            document.getElementById(itemCountBottomId).textContent = `Affichage de ${totalRows} ${rowClass === 'organisme-row' ? 'organismes' : 'formations'}`;
            document.getElementById(pageInfoBottomId).textContent = `Page ${page} sur ${totalPages}`;
            document.getElementById(prevBtnId).disabled = page === 1;
            document.getElementById(nextBtnId).disabled = page === totalPages;
            document.getElementById(prevBtnBottomId).disabled = page === 1;
            document.getElementById(nextBtnBottomId).disabled = page === totalPages;
        }

        document.getElementById(itemsPerPageId).addEventListener('change', function() {
            itemsPerPage = parseInt(this.value);
            currentPage = 1;
            update();
        });
        document.getElementById(prevBtnId).addEventListener('click', function() {
            if (currentPage > 1) { currentPage--; update(); }
        });
        document.getElementById(nextBtnId).addEventListener('click', function() {
            currentPage++; update();
        });
        document.getElementById(prevBtnBottomId).addEventListener('click', function() {
            if (currentPage > 1) { currentPage--; update(); }
        });
        document.getElementById(nextBtnBottomId).addEventListener('click', function() {
            currentPage++; update();
        });

        update();
        return update;
    }

    // Voir/Cacher Organismes
    const btnToggleOrganismes = document.getElementById('btnToggleOrganismes');
    const tableOrganismes = document.getElementById('tableOrganismes');
    const exportOrganismes = document.getElementById('exportOrganismes');
    const paginationOrganismesTop = document.getElementById('paginationOrganismesTop');
    const paginationOrganismesBottom = document.getElementById('paginationOrganismesBottom');
    let organismesVisible = false;
    let updateOrganismesPagination = null;

    btnToggleOrganismes.addEventListener('click', function() {
        organismesVisible = !organismesVisible;
        tableOrganismes.style.display = organismesVisible ? '' : 'none';
        exportOrganismes.style.display = organismesVisible ? '' : 'none';
        paginationOrganismesTop.style.display = organismesVisible ? '' : 'none';
        paginationOrganismesBottom.style.display = organismesVisible ? '' : 'none';
        btnToggleOrganismes.innerHTML = organismesVisible ? '<i class="fas fa-eye-slash"></i> Cacher les organismes' : '<i class="fas fa-eye"></i> Voir les organismes';
        if (organismesVisible && !updateOrganismesPagination) {
            updateOrganismesPagination = setupPagination(
                'tableOrganismes', 'paginationOrganismesTop', 'paginationOrganismesBottom', 'itemsPerPageOrganismes',
                'organisme-row', 'itemCountOrganismes', 'pageInfoOrganismes', 'prevPageOrganismes', 'nextPageOrganismes',
                'itemCountOrganismesBottom', 'pageInfoOrganismesBottom', 'prevPageOrganismesBottom', 'nextPageOrganismesBottom'
            );
        } else if (organismesVisible && updateOrganismesPagination) {
            updateOrganismesPagination();
        }
    });

    // Voir/Cacher Formations
    const btnToggleFormations = document.getElementById('btnToggleFormations');
    const tableFormations = document.getElementById('tableFormations');
    const exportFormations = document.getElementById('exportFormations');
    const paginationFormationsTop = document.getElementById('paginationFormationsTop');
    const paginationFormationsBottom = document.getElementById('paginationFormationsBottom');
    let formationsVisible = false;
    let updateFormationsPagination = null;

    btnToggleFormations.addEventListener('click', function() {
        formationsVisible = !formationsVisible;
        tableFormations.style.display = formationsVisible ? '' : 'none';
        exportFormations.style.display = formationsVisible ? '' : 'none';
        paginationFormationsTop.style.display = formationsVisible ? '' : 'none';
        paginationFormationsBottom.style.display = formationsVisible ? '' : 'none';
        btnToggleFormations.innerHTML = formationsVisible ? '<i class="fas fa-eye-slash"></i> Cacher les formations' : '<i class="fas fa-eye"></i> Voir les formations';
        if (formationsVisible && !updateFormationsPagination) {
            updateFormationsPagination = setupPagination(
                'tableFormations', 'paginationFormationsTop', 'paginationFormationsBottom', 'itemsPerPageFormations',
                'formation-row', 'itemCountFormations', 'pageInfoFormations', 'prevPageFormations', 'nextPageFormations',
                'itemCountFormationsBottom', 'pageInfoFormationsBottom', 'prevPageFormationsBottom', 'nextPageFormationsBottom'
            );
        } else if (formationsVisible && updateFormationsPagination) {
            updateFormationsPagination();
        }
    });
    </script>


    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Gestion des onglets
        const tabButtons = document.querySelectorAll('.options-tab-buttons .tab-btn');
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // Désactive tous les onglets
                document.querySelectorAll('.options-tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                tabButtons.forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Active l'onglet sélectionné
                this.classList.add('active');
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });
        
        // Gestion de l'ajout d'options
        const addForms = document.querySelectorAll('.add-option-form');
        addForms.forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const type = this.getAttribute('data-type');
                const value = this.querySelector('input').value.trim();

                if (value) {
                    fetch('/admin/add-option', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ type, value })
                    })
                    .then(async response => {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            return response.json();
                        } else {
                            throw new Error('Réponse non JSON du serveur');
                        }
                    })
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('Erreur: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Une erreur est survenue: ' + error.message);
                    });
                }
            });
        });

        // Gestion de la suppression d'options
        document.querySelectorAll('.btn-delete-option').forEach(button => {
            button.addEventListener('click', function() {
                const type = this.getAttribute('data-type');
                const value = this.getAttribute('data-value');

                if (confirm(`Êtes-vous sûr de vouloir supprimer "${value}" ?`)) {
                    fetch('/admin/delete-option', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ type, value })
                    })
                    .then(async response => {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            return response.json();
                        } else {
                            throw new Error('Réponse non JSON du serveur');
                        }
                    })
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('Erreur: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Une erreur est survenue: ' + error.message);
                    });
                }
            });
        });

        // Gestion de l'édition d'options
        document.querySelectorAll('.btn-edit-option').forEach(button => {
            button.addEventListener('click', function() {
                const type = this.getAttribute('data-type');
                const oldValue = this.getAttribute('data-value');
                const newValue = prompt(`Modifier ${type} "${oldValue}" :`, oldValue);

                if (newValue && newValue !== oldValue) {
                    fetch('/admin/update-option', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ type, oldValue, newValue })
                    })
                    .then(async response => {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            return response.json();
                        } else {
                            throw new Error('Réponse non JSON du serveur');
                        }
                    })
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('Erreur: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Une erreur est survenue: ' + error.message);
                    });
                }
            });
        });
    });
    </script>
</body>
</html>