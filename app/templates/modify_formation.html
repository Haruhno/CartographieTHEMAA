<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modifier la formation</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        {% include 'includes/nav.html' %}

        <div class="main-content">
            <header>
                <div class="header-content">
                    <h1><i class="fas fa-edit"></i> Modifier la formation</h1>
                    <div class="user-info">
                        <a href="{{ url_for('utilisateur.deconnexion') }}" class="btn-logout">
                            <i class="fas fa-sign-out-alt"></i> Déconnexion
                        </a>
                    </div>
                </div>
            </header>

            <div class="content">
                <div class="form-container">
                    <form id="modificationForm" action="{{ url_for('formation.modify_with_reason') }}" method="POST">
                        <input type="hidden" name="id" value="{{ formation.id_formation }}">

                        <!-- Informations générales -->
                        <div class="form-section">
                            <h2 class="section-title"><i class="fas fa-info-circle"></i> Informations générales</h2>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="nom" class="required-field">Nom de la formation</label>
                                    <input type="text" id="nom" name="nom" value="{{ formation.nom }}" required 
                                           class="form-control" placeholder="Nom de la formation">
                                </div>

                                <div class="form-group">
                                    <label for="type" class="required-field">Type de formation</label>
                                    <select id="type" name="type" required class="form-control">
                                        <option value="initiale" {% if formation.type == 'initiale' %}selected{% endif %}>Initiale</option>
                                        <option value="continue" {% if formation.type == 'continue' %}selected{% endif %}>Continue</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="description" class="required-field">Description</label>
                                <textarea id="description" name="description" required class="form-control" 
                                          rows="4" placeholder="Description détaillée de la formation">{{ formation.description }}</textarea>
                            </div>
                        </div>

                        <!-- Durée et dates -->
                        <div class="form-section">
                            <h2 class="section-title"><i class="fas fa-clock"></i> Durée et dates</h2>
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label class="required-field" style="display:block;">Plage de date</label>
                                <input type="text" name="dates" id="dates-input" value="{{ formation.dates }}" required>
                            </div>
                            <div class="form-group" style="margin-bottom: 18px;">
                                <div class="checkbox-item" style="align-items: center;">
                                    <input type="checkbox" id="dates_futures" name="dates_futures" style="margin:0 8px 0 0; vertical-align: middle;">
                                    <label for="dates_futures" style="color: #222; font-weight: 400; cursor: pointer; display: inline-block; vertical-align: middle; margin:0;">Dates à venir (non encore déterminées)</label>
                                </div>
                            </div>
                            <div class="form-row" style="align-items: flex-end; margin-bottom: 0; gap: 24px;">
                                <div class="form-group" style="flex:1;">
                                    <label class="required-field" style="display:block;">Durée (heures)</label>
                                    <input type="text" 
                                           name="duree_heures" 
                                           value="{{ formation.duree_heures }}"
                                           required
                                           inputmode="decimal"
                                           min="0"
                                           style="width:100%;"
                                           oninput="
                                               const inputValue = this.value;
                                               let cleanValue = inputValue.replace(',', '.');
                                               cleanValue = cleanValue.replace(/[^\d.]/g, '');
                                               const [entier, decimales] = cleanValue.split('.');
                                               if (decimales !== undefined) {
                                                   cleanValue = entier + '.' + decimales.slice(0, 2);
                                               }
                                               this.value = cleanValue;
                                           "
                                           maxlength="8"
                                           placeholder="ex : 75.50"
                                    >
                                </div>
                                <div class="form-group" style="flex:1; position: relative;">
                                    <label class="required-field" style="display:block;">Durée</label>
                                    <div style="display: flex; gap: 10px; align-items: flex-end;">
                                        <input type="text" name="duree_valeur" style="width: 80px;" required
                                            inputmode="decimal"
                                            pattern="^\d+([.]\d{0,1})?$"
                                            value="{{ formation.duree.split(' ')[0] if formation.duree else '' }}"
                                            oninput="
                                                this.value = this.value.replace(',', '.');
                                                this.value = this.value.replace(/[^0-9.]/g, '');
                                                const dureePartsInput = this.value.split('.');
                                                if (dureePartsInput.length > 2) {
                                                    this.value = dureePartsInput[0] + '.' + dureePartsInput[1];
                                                }
                                                if (dureePartsInput[1] && dureePartsInput[1].length > 1) {
                                                    this.value = dureePartsInput[0] + '.' + dureePartsInput[1].slice(0,1);
                                                }
                                            "
                                            maxlength="6"
                                            placeholder="ex : 10"
                                        />
                                        <select name="duree_unite" required>
                                            <option value="jours" {% if 'jour' in formation.duree %}selected{% endif %}>jour(s)</option>
                                            <option value="semaines" {% if 'semaine' in formation.duree %}selected{% endif %}>semaine(s)</option>
                                            <option value="mois" {% if 'mois' in formation.duree %}selected{% endif %}>mois</option>
                                            <option value="annees" {% if 'année' in formation.duree %}selected{% endif %}>année(s)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Lieu et prix -->
                        <div class="form-section">
                            <h2 class="section-title"><i class="fas fa-map-marker-alt"></i> Lieu et tarif</h2>
                            <div class="form-group">
                                <label class="required-field">Lieu</label>
                                <input type="text" id="lieu" name="lieu" value="{{ formation.lieu }}" required 
                                       class="form-control" placeholder="Adresse complète">
                            </div>
                            <div class="form-group">
                                <label>Prix (€)</label>
                                <input type="text" 
                                       name="prix" 
                                       value="{{ formation.prix }}"
                                       inputmode="decimal" 
                                       pattern="^\d{1,5}([,.]\d{0,2})?$" 
                                       class="form-control"
                                       oninput="
                                           this.value = this.value.replace(/[^0-9.,]/g, '');
                                           this.value = this.value.replace(',', '.');
                                           const priceParts = this.value.split('.');
                                           if (priceParts.length > 2) {
                                               this.value = priceParts[0] + '.' + priceParts[1];
                                           }
                                           if (priceParts[1] && priceParts[1].length > 2) {
                                               this.value = priceParts[0] + '.' + priceParts[1].slice(0,2);
                                           }
                                       "
                                       maxlength="8"
                                       placeholder="ex : 123.30">
                            </div>
                        </div>

                        <!-- Informations complémentaires -->
                        <div class="form-section">
                            <h2 class="section-title"><i class="fas fa-plus-circle"></i> Informations complémentaires</h2>
                            
                            <div class="form-group">
                                <label for="conditions_acces">Conditions d'accès</label>
                                <textarea id="conditions_acces" name="conditions_acces" class="form-control" 
                                          rows="3" placeholder="Prérequis, public visé...">{{ formation.conditions_acces }}</textarea>
                            </div>

                            <div class="form-group">
                                <label for="financement">Financement</label>
                                <input type="text" id="financement" name="financement" value="{{ formation.financement }}" 
                                       class="form-control" placeholder="Options de financement">
                            </div>

                            <div class="form-group">
                                <label for="presentation_intervenants">Présentation des intervenant·es</label>
                                <textarea id="presentation_intervenants" name="presentation_intervenants" class="form-control" 
                                          rows="3" placeholder="Expérience, spécialités...">{{ formation.presentation_intervenants }}</textarea>
                            </div>

                            <div class="form-group">
                                <label for="lien_inscription">Lien d'inscription</label>
                                <input type="url" id="lien_inscription" name="lien_inscription" 
                                       value="{{ formation.lien_inscription }}" class="form-control"
                                       pattern="https?://.+"
                                       placeholder="https://exemple.com"
                                       title="L'URL doit commencer par http:// ou https://">
                            </div>
                        </div>

                        <!-- Labels et Certifications -->
                        <div class="form-section">
                            <h2 class="section-title"><i class="fas fa-tag"></i> Labels et Certifications</h2>
                            <div class="alert alert-info" style="margin-bottom: 20px;">
                                <i class="fas fa-info-circle"></i>
                                Pour ajouter ou modifier un label ou une certification, veuillez contacter un administrateur via 
                                <a href="{{ url_for('utilisateur.support') }}" style="color: var(--primary-color); text-decoration: underline;">le formulaire de support</a>.
                            </div>
                            <div class="form-group">
                                <label>Labels actuels</label>
                                <input type="text" value="{{ formation.label }}" class="form-control" readonly disabled>
                            </div>
                            <div class="form-group">
                                <label>Certifications actuelles</label>
                                <input type="text" value="{{ formation.certifications }}" class="form-control" readonly disabled>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn btn-primary" id="submitModification">
                                <i class="fas fa-save"></i> Enregistrer les modifications
                            </button>
                            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Annuler
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de raison -->
    <div id="reasonModal" class="modal-overlay" style="display: none;">
        <div class="modal-box">
            <h3><i class="fas fa-pencil-alt"></i> Raison de la modification</h3>
            <p class="modal-description">
                Veuillez indiquer la raison de cette modification. Cette information sera utilisée pour le suivi des changements.
            </p>
            <textarea id="reasonText" maxlength="1000" placeholder="Décrivez brièvement la raison de cette modification..."></textarea>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="cancelReason">
                    <i class="fas fa-times"></i> Annuler
                </button>
                <button class="btn btn-primary" id="confirmReason">
                    <i class="fas fa-check"></i> Confirmer
                </button>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>
    <script>
        $(document).ready(function() {
            // Validation du formulaire
            function validateForm() {
                let isValid = true;
                const requiredFields = document.querySelectorAll('[required]');
                
                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        field.classList.add('error');
                        isValid = false;
                    } else {
                        field.classList.remove('error');
                    }
                });

                // Validation spécifique pour l'URL
                const urlField = document.getElementById('lien_inscription');
                if (urlField.value && !urlField.value.match(/^https?:\/\/.+/)) {
                    urlField.classList.add('error');
                    isValid = false;
                }

                return isValid;
            }

            // Gestion du modal
            $('#submitModification').click(function(e) {
                e.preventDefault();
                if (validateForm()) {
                    $('#reasonModal').show();
                }
            });

            $('#cancelReason').click(function() {
                $('#reasonModal').hide();
            });

            $('#confirmReason').click(function() {
                const reason = $('#reasonText').val().trim();
                if (!reason) {
                    alert('Veuillez indiquer une raison pour la modification');
                    return;
                }

                $('<input>').attr({
                    type: 'hidden',
                    name: 'reason',
                    value: reason
                }).appendTo('#modificationForm');

                $('#modificationForm').submit();
            });

            // Fermer le modal en cliquant en dehors
            $(window).click(function(event) {
                if (event.target.className === 'modal-overlay') {
                    $('#reasonModal').hide();
                }
            });
        });

        // Gestion checkbox dates futures
        const datesFutures = document.getElementById('dates_futures');
        const datesInput = document.getElementById('dates-input');

        if (datesFutures && datesInput) {
            // Initialiser l'état de l'input de dates
            let datePicker = null;
            
            // Configuration de base de Flatpickr
            function initializeDatePicker() {
                datePicker = flatpickr("#dates-input", {
                    mode: "range",
                    dateFormat: "d/m/Y",
                    locale: "fr",
                    minDate: "today",
                    allowInput: false,
                    enableTime: false,
                    disableMobile: true
                });
            }

            // Initialiser le datepicker
            initializeDatePicker();

            // Gérer le changement d'état de la checkbox
            datesFutures.addEventListener('change', function() {
                if (this.checked) {
                    // Désactiver et nettoyer le datepicker
                    if (datePicker) {
                        datePicker.destroy();
                    }
                    datesInput.value = 'Dates à venir';
                    datesInput.readOnly = true;
                    datesInput.style.backgroundColor = '#f5f5f5';
                    datesInput.style.cursor = 'not-allowed';
                } else {
                    // Réactiver le datepicker
                    datesInput.value = '';
                    datesInput.readOnly = false;
                    datesInput.style.backgroundColor = '';
                    datesInput.style.cursor = '';
                    initializeDatePicker();
                }
            });

            // Si la page se charge avec "Dates à venir" déjà coché
            if (datesFutures.checked) {
                datesInput.value = 'Dates à venir';
                datesInput.readOnly = true;
                datesInput.style.backgroundColor = '#f5f5f5';
                datesInput.style.cursor = 'not-allowed';
                if (datePicker) {
                    datePicker.destroy();
                }
            }
        }

        flatpickr("#dates-input", {
            mode: "range",
            dateFormat: "d/m/Y",
            locale: "fr",
            minDate: "today",
            allowInput: false,
            enableTime: false,
            disableMobile: true,
            defaultDate: "{{ formation.dates }}"
        });

        document.addEventListener('DOMContentLoaded', function() {
            const lieuInput = document.getElementById('lieu');
            let timeoutId = null;

            lieuInput.addEventListener('input', function() {
                if (timeoutId) clearTimeout(timeoutId);
                
                const searchText = this.value.trim();
                if (searchText.length < 3) return;

                timeoutId = setTimeout(() => {
                    const url = `https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(searchText)}&limit=5`;
                    
                    fetch(url)
                        .then(response => response.json())
                        .then(data => {
                            if (data.features && data.features.length > 0) {
                                showLieuSuggestions(data.features, lieuInput);
                            }
                        })
                        .catch(error => console.error('Erreur:', error));
                }, 300);
            });
        });

        function showLieuSuggestions(features, lieuInput) {
            let suggestionList = document.getElementById('lieu-suggestions');
            if (suggestionList) {
                suggestionList.remove();
            }

            suggestionList = document.createElement('ul');
            suggestionList.id = 'lieu-suggestions';
            suggestionList.className = 'suggestions-list';

            features.forEach(feature => {
                const li = document.createElement('li');
                li.textContent = feature.properties.label;
                li.addEventListener('click', () => {
                    lieuInput.value = feature.properties.label;
                    suggestionList.remove();
                });
                suggestionList.appendChild(li);
            });

            lieuInput.parentNode.style.position = 'relative';
            lieuInput.parentNode.appendChild(suggestionList);
        }

        // Fermer les suggestions quand on clique ailleurs
        document.addEventListener('click', (e) => {
            const suggestionList = document.getElementById('lieu-suggestions');
            if (suggestionList && !suggestionList.contains(e.target) && e.target.id !== 'lieu') {
                suggestionList.remove();
            }
        });
    </script>

    <style>
        .form-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .form-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .section-title {
            color: var(--primary-color);
            font-size: 1.2rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(30,144,255,0.1);
            outline: none;
        }

        .form-control.error {
            border-color: var(--danger-color);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
        }

        .modal-description {
            color: #666;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .required-field::after {
            content: " *";
            color: var(--danger-color);
        }

        /* Styles pour l'autocomplétion */
        .suggestions-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            list-style: none;
            padding: 0;
            margin: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .suggestions-list li {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s ease;
        }

        .suggestions-list li:last-child {
            border-bottom: none;
        }

        .suggestions-list li:hover {
            background-color: #f5f5f5;
        }

        .form-group {
            position: relative;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .form-actions .btn {
                width: 100%;
            }
        }
    </style>
</body>
</html>